syntax = "proto3";

package payments.v1;

import "audits/v1/voucher_transaction.proto";
import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";

/**
 * GiftVoucher (Bon d'Achat)
 * Prepaid credit that can be used for future purchases.
 * Like a gift card or store credit.
 *
 * Example:
 *   voucher_id: "GV-2025-001"
 *   voucher_code: "GIFT-XMAS-12345"
 *   initial_value: 100000
 *   remaining_value: 100000
 *   issued_to_customer_id: "CMP-003"
 *   valid_until: 2026-12-31
 *   status: VOUCHER_STATUS_ACTIVE
 */
message GiftVoucher {
  // "GV-2025-001"
  string document_id = 1 [(buf.validate.field).required = true];
  // "GIFT-XMAS-12345" - what customer uses
  string voucher_code = 2;
  // Original amount
  double initial_value = 3;
  // What's left
  double remaining_value = 4;
  string currency = 5;
  // Optional - can be transferred
  optional string issued_to_customer_id = 6;
  string issued_by_user_id = 7;
  // Warehouse where the voucher was issued
  string warehouse_id = 8;
  VoucherStatus status = 9;
  google.protobuf.Timestamp issued_at = 10;
  google.protobuf.Timestamp valid_until = 11;
  optional string notes = 12;
}

enum VoucherStatus {
  VOUCHER_STATUS_UNSPECIFIED = 0;
  VOUCHER_STATUS_ACTIVE = 1; // Can be used
  VOUCHER_STATUS_PARTIALLY_USED = 2; // Some value used
  VOUCHER_STATUS_FULLY_USED = 3; // No value left
  VOUCHER_STATUS_EXPIRED = 4; // Past valid_until date
  VOUCHER_STATUS_CANCELLED = 5; // Voided
}

message ValidateVoucherRequest {
  string voucher_code = 1;
}

message ValidateVoucherResponse {
  bool is_valid = 1;
  string voucher_id = 2;
  double remaining_value = 3;
  google.protobuf.Timestamp valid_until = 4;
  VoucherStatus status = 5;
  string message = 6;
}

message GetVoucherRequest {
  oneof identifier {
    string voucher_id = 1;
    string voucher_code = 2;
  }
}

message GetVoucherResponse {
  GiftVoucher voucher = 1;
  // Usage history.
  repeated audits.v1.VoucherTransaction transactions = 2;
}

message ListVouchersRequest {
  string warehouse_id = 1;
  optional string customer_id = 2;
  optional google.protobuf.Timestamp issued_after = 3;
  int32 page_size = 4;
  int32 page_number = 5;
}

message ListVouchersResponse {
  repeated GiftVoucher vouchers = 1;
  int32 total_count = 2;
  double total_value = 3;
}

service GiftVoucherService {
  // Validate voucher before use
  rpc ValidateVoucher(ValidateVoucherRequest) returns (ValidateVoucherResponse);

  // Get voucher details
  rpc GetVoucher(GetVoucherRequest) returns (GetVoucherResponse);

  // List vouchers with filtering
  rpc ListVouchers(ListVouchersRequest) returns (ListVouchersResponse);
}
